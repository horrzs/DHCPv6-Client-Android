name: Build dhcp6c binaries (arm64-v8a)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ABI: arm64-v8a
      ANDROID_PLATFORM: android-24
      NDK_VERSION: 26.2.11394342

    steps:
      - name: Checkout (with submodules + LFS)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true
          fetch-depth: 0

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK + CMake + Ninja
        shell: bash
        run: |
          set -euxo pipefail
          sdkmanager --install "ndk;${NDK_VERSION}" "cmake;3.22.1" "platforms;android-21"
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Debug - verify wide-dhcpv6 sources exist
        shell: bash
        run: |
          set -euxo pipefail
          ls -la mobile/src/main || true
          ls -la mobile/src/main/cpp || true
          find mobile/src/main/cpp -maxdepth 2 -type d -print || true
          test -f mobile/src/main/cpp/wide-dhcpv6/addrconf.c

      - name: Patch source for NDK clang
        shell: bash
        run: |
          set -euxo pipefail
          F="mobile/src/main/cpp/wide-dhcpv6/addrconf.c"
          # 如果没包含 time.h，就在第一个 #include 行前插入（或你也可以插到固定位置）
          if ! grep -qE '^\s*#\s*include\s*<time\.h>' "$F"; then
            # 在第一行 #include 前插入一行 #include <time.h>
            awk 'NR==1{print} /^\s*#\s*include/ && !done {print "#include <time.h>"; done=1} {print}' "$F" > "$F.tmp"
            mv "$F.tmp" "$F"
          fi
          grep -n "include <time.h>" -n "$F" || true

      - name: Patch wide-dhcpv6 for modern NDK
        shell: bash
        run: |
          set -euxo pipefail

          W="mobile/src/main/cpp/wide-dhcpv6"

          # 1) 给所有 .c 文件：如果出现 "time(" 且没 include <time.h>，就补上
          for f in "$W"/*.c; do
            if grep -q "time(" "$f"; then
              if ! grep -q '^#include <time.h>' "$f"; then
                sed -i '1i#include <time.h>' "$f"
              fi
            fi
          done

          # 2) common.c: bcmp -> memcmp（更稳）
          if [ -f "$W/common.c" ]; then
            sed -i 's/\bbcmp\s*(/memcmp(/g' "$W/common.c" || true

            # memcmp 需要 <string.h>
            if ! grep -q '^#include <string.h>' "$W/common.c"; then
              sed -i '1i#include <string.h>' "$W/common.c"
            fi
          fi

          # 3) 打印一下确认（可选）
          grep -n '^#include <time.h>' "$W"/*.c || true


      - name: Configure (CMake)
        shell: bash
        run: |
          set -euxo pipefail
          ANDROID_NDK_HOME="${ANDROID_SDK_ROOT}/ndk/${NDK_VERSION}"
          cmake -S mobile -B "build-${ABI}" -G Ninja -DANDROID_ABI="${ABI}" -DANDROID_PLATFORM="${ANDROID_PLATFORM}" -DANDROID_NDK="${ANDROID_NDK_HOME}" -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" -DCMAKE_BUILD_TYPE=Release -Wno-dev

      - name: Build (CMake)
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build "build-${ABI}" --target libdhcp6c.so libdhcp6ctl.so

      - name: Collect outputs
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "out/${ABI}"
          DHCP6C="$(find "build-${ABI}" -maxdepth 5 -type f -name "libdhcp6c.so" | head -n 1)"
          DHCP6CTL="$(find "build-${ABI}" -maxdepth 5 -type f -name "libdhcp6ctl.so" | head -n 1)"
          test -n "${DHCP6C}"
          test -n "${DHCP6CTL}"
          cp -v "${DHCP6C}" "out/${ABI}/"
          cp -v "${DHCP6CTL}" "out/${ABI}/"
          chmod 755 "out/${ABI}/libdhcp6c.so" "out/${ABI}/libdhcp6ctl.so"
          file "out/${ABI}/libdhcp6c.so" || true
          file "out/${ABI}/libdhcp6ctl.so" || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dhcp6c-arm64-v8a
          path: out/arm64-v8a/
          if-no-files-found: error
